{% block contents %}
<div id="wrap">
    <div class="content">
        <div class="main">
            <h1 class="page-title">実行ライン一覧</h1>
            
            <div class="filter-area">
                <form id="form-filter" method="get" action="" class="filter-form"> 
                    <button type="button" class="btn-filter" data-no="1">マクロ</button>
                    <button type="button" class="btn-filter" data-no="2">SQL</button>
                    <button type="button" class="btn-filter" data-no="3">正規表現</button>
                    <button type="button" class="btn-filter" data-no="">全表示</button>
                </form>
            </div>

            {% for item in executeline_list %}
                <div class="execute-line-card" id="card-{{ item.no }}">
                    <div class="card-header">
                        <h2 class="card-title">
                            <strong>No. {{ item.no }}</strong> / {{ item.get_type_display }}
                        </h2>
                        
                        <form id="form-{{ item.no }}" method="post" action="" class="execute-form"> 
                            {% csrf_token %}
                            <input type="hidden" name="no" value="{{ item.no }}"> 
                            <input type="hidden" name="type" value="{{ item.type }}" id="line-input-{{ item.no }}">
                            <input type="hidden" name="line" value="{{ item.line }}">
                            
                            <button type="button" class="btn-edit" data-no="{{ item.no }}">修正</button>
                            <button type="button" class="btn-execute" data-no="{{ item.no }}">実行</button>
                        </form>
                    </div>

                    <div class="card-meta">
                        [利用: {{ item.get_available_user_display }}] | 
                        [出力: {{ item.get_output_type_display }}] | 
                        [更新: {{ item.update_date|date:"Y-m-d" }}]
                        
                        {% if item.type == 3 %}
                        <div class="line-input-area">
                            <textarea 
                                id="line-input-val-{{ item.no }}"
                                name="content_input_no_{{ item.no }}"
                                placeholder="実行に必要な値を入力してください..."
                                class="user-input-field"
                                form="form-{{ item.no }}"
                            ></textarea>
                        </div>
                        {% endif %}

                        <div class="line-detail-container {% if item.type == 3 %}is-type-3{% endif %}">
                            <div class="line-detail" id="display-{{ item.no }}"><p>{{ item.line|linebreaksbr }}</p></div>
                            <textarea id="edit-{{ item.no }}" class="line-edit-field" name="edited_content_no_{{ item.no }}" form="form-{{ item.no }}" style="display:none;">{{ item.line }}</textarea>
                            
                            {% if item.type == 3 %}
                                <div class="line-detail" id="display2-{{ item.no }}"><p>{{ item.line2|linebreaksbr }}</p></div>
                                <textarea id="edit2-{{ item.no }}" class="line-edit-field" name="edited_content2_no_{{ item.no }}" form="form-{{ item.no }}" style="display:none;">{{ item.line2 }}</textarea>
                            {% endif %}
                        </div>
                    </div>
                    <div id="result-container-{{ item.no }}" class="result-container"></div>
                </div>
            {% endfor %}
        </div>
    </div>
</div>
{% endblock %}

<script>
    const csrftoken = document.cookie.split('; ').find(row => row.startsWith('csrftoken='))?.split('=')[1];

    document.addEventListener('DOMContentLoaded', function() {
        document.querySelectorAll('form').forEach(form => {
            form.addEventListener('keydown', e => {
                if (e.key === 'Enter' && e.target.tagName !== 'TEXTAREA') e.preventDefault();
            });
        });

        document.querySelectorAll('.btn-filter').forEach(button => {
            button.addEventListener('click', function() {
                const filterNo = this.getAttribute('data-no');
                const url = new URL(window.location.href);
                if (filterNo) url.searchParams.set('filter-no', filterNo);
                else url.searchParams.delete('filter-no');
                window.location.href = url.toString();
            });
        });

        document.querySelectorAll('.btn-edit').forEach(button => {
            button.addEventListener('click', function() {
                const no = this.getAttribute('data-no');
                const elements = [
                    { disp: document.getElementById(`display-${no}`), edit: document.getElementById(`edit-${no}`) },
                    { disp: document.getElementById(`display2-${no}`), edit: document.getElementById(`edit2-${no}`) }
                ];
                const execBtn = document.querySelector(`.btn-execute[data-no="${no}"]`);
                const isEditing = elements[0].edit.style.display !== 'none';

                elements.forEach(el => {
                    if (el.edit) {
                        el.edit.style.display = isEditing ? 'none' : 'block';
                        if (el.disp) el.disp.style.display = isEditing ? 'block' : 'none';
                    }
                });

                this.textContent = isEditing ? '修正' : '修正キャンセル';
                this.classList.toggle('active', !isEditing);
                execBtn.textContent = isEditing ? '実行' : '保存して実行';
            });
        });

        document.querySelectorAll('.btn-execute').forEach(button => {
            button.addEventListener('click', async function() {
                const no = this.getAttribute('data-no');
                const inputVal = document.getElementById(`line-input-val-${no}`);
                const lineType = document.getElementById(`line-input-${no}`).value;

                if(lineType === '3' && (!inputVal || !inputVal.value.trim())) {
                    alert("実行に必要な値を入力してください。");
                    return;
                }

                const container = document.getElementById(`result-container-${no}`);
                const form = document.getElementById(`form-${no}`);
                const editArea = document.getElementById(`edit-${no}`);
                const isEditing = editArea && editArea.style.display !== 'none';

                this.disabled = true;
                const originalText = this.textContent;
                this.textContent = '実行中...';
                container.innerHTML = `<div class="status-processing">実行中...</div>`;

                const formData = new FormData(form);
                if (isEditing) formData.append('modification_flag', '1');

                try {
                    const response = await fetch(window.location.href, {
                        method: 'POST',
                        headers: { 'X-CSRFToken': csrftoken },
                        body: formData
                    });
                    const result = await response.json();

                    if (response.ok) {
                        container.innerHTML = generateResultHtml(result);
                        if (isEditing && result.success) {
                            updateDisplay(no, 1);
                            updateDisplay(no, 2);
                            document.querySelector(`.btn-edit[data-no="${no}"]`).click(); // 修正モード解除
                        }
                    } else {
                        container.innerHTML = generateErrorHtml(result.error || "エラーが発生しました。");
                    }
                } catch (error) {
                    container.innerHTML = generateErrorHtml("通信エラー: " + error.message);
                } finally {
                    this.disabled = false;
                    this.textContent = isEditing ? '実行' : originalText;
                }
            });
        });

        function updateDisplay(no, suffix) {
            const edit = document.getElementById(`edit${suffix === 1 ? '' : '2'}-${no}`);
            const disp = document.getElementById(`display${suffix === 1 ? '' : '2'}-${no}`);
            if (edit && disp) disp.innerHTML = `<p>${edit.value.replace(/\n/g, '<br>')}</p>`;
        }

        function generateResultHtml(res) {
            const statusClass = res.success ? 'status-success' : 'status-failure';
            let html = `<div class="execution-status-box ${statusClass}">
                <h4>${res.success ? '✅ 実行成功' : '❌ 実行失敗'} (${res.type})</h4>
                <div class="executed-query-header"><b>実行クエリ:</b>`;
            
            if (res.type === 'REGEX' && res.success) html += `<button type="button" class="btn-copy" onclick="copyText(this)">コピー</button>`;
            
            html += `</div><pre class="executed-query-pre">${res.executed_query}</pre>`;

            if (res.type === 'SELECT' && res.data) {
                html += `<h5 style="margin:10px 0 5px">取得結果 (${res.count}件)</h5>
                         <div class="result-table-wrapper"><table class="result-table"><thead><tr>`;
                if(res.data.length > 0) {
                    res.columns.forEach(col => html += `<th>${col}</th>`);
                    html += `</tr></thead><tbody>`;
                    res.data.forEach(row => {
                        html += `<tr>${row.map(cell => `<td>${cell ?? 'NULL'}</td>`).join('')}</tr>`;
                    });
                    html += `</tbody></table></div>`;
                } else {
                    html += `<th>データなし</th></tr></thead></table></div>`;
                }
            } else if (res.type === 'DML/DDL') {
                html += `<p><b>結果:</b> ${res.count} 行が影響を受けました。</p>`;
            }
            return html + `</div>`;
        }
    });

    function copyText(btn) {
        const text = btn.closest('.execution-status-box').querySelector('.executed-query-pre').textContent;
        navigator.clipboard.writeText(text).then(() => {
            const old = btn.textContent;
            btn.textContent = '完了';
            setTimeout(() => btn.textContent = old, 1500);
        });
    }

    function generateErrorHtml(msg) {
        return `<div class="execution-status-box status-failure"><h4>❌ 実行失敗</h4><pre class="error-pre">${msg}</pre></div>`;
    }
</script>

<style>
#wrap { max-width: 800px; margin: 0 auto; padding: 10px; font-family: sans-serif; }
.page-title { border-bottom: 2px solid #007bff; padding-bottom: 5px; font-size: 1.5em; }
.filter-form { display: flex; gap: 10px; margin-bottom: 20px; padding: 10px; background: #f8f9fa; border-radius: 8px; border: 1px solid #e0e0e0; }
.btn-filter { padding: 8px 16px; border: 1px solid #007bff; background: #fff; color: #007bff; border-radius: 20px; cursor: pointer; font-weight: bold; }
.btn-filter:hover { background: #e7f1ff; }
.execute-line-card { border: 1px solid #ccc; border-radius: 4px; padding: 15px; margin-bottom: 15px; background: #fff; }
.card-header { display: flex; justify-content: space-between; align-items: center; }
.card-title { font-size: 1.2em; color: #007bff; margin:0; }
.btn-edit, .btn-execute { border: none; padding: 5px 12px; border-radius: 4px; cursor: pointer; font-size: 0.9em; margin-left: 5px; }
.btn-edit { background: #ffc107; }
.btn-edit.active { background: #dc3545; color: #fff; }
.btn-execute { background: #28a745; color: #fff; }
.btn-execute:disabled { background: #6c757d; }
.card-meta { font-size: 0.85em; color: #6c757d; margin-top: 5px; }
.user-input-field, .line-edit-field { width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; font-family: monospace; }
.line-edit-field { height: 120px; margin-top: 10px; }
.line-detail { background: #f0f0f0; padding: 10px; border-radius: 3px; white-space: pre-wrap; font-family: monospace; margin-top: 5px; }
.is-type-3 { display: flex; gap: 10px; }
.is-type-3 > * { flex: 1; }
.execution-status-box { padding: 15px; border-radius: 4px; border: 1px solid #ccc; margin-top: 15px; }
.status-success { border-color: #28a745; }
.status-success h4 { background: #d4edda; margin: -15px -15px 10px; padding: 10px; color: #155724; }
.status-failure { border-color: #dc3545; }
.status-failure h4 { background: #f8d7da; margin: -15px -15px 10px; padding: 10px; color: #721c24; }
.executed-query-pre { background: #f0f0f0; padding: 10px; font-size: 0.9em; overflow-x: auto; }
.result-table-wrapper { max-height: 200px; overflow: auto; border: 1px solid #ddd; }
.result-table { width: 100%; border-collapse: collapse; font-size: 0.85em; }
.result-table th, .result-table td { border: 1px solid #ddd; padding: 6px; }
.result-table thead { background: #eee; position: sticky; top: 0; }
.btn-copy { background: #007bff; color: #fff; border: none; padding: 2px 8px; border-radius: 3px; cursor: pointer; float: right; }
</style>